<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact-Based Real-Time Chat</title>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
      // We need getDoc and setDoc for managing the user's contact list
      import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

      // Make Firebase functions globally available
      window.firebase = {
        initializeApp,
        getAuth, signInAnonymously, onAuthStateChanged,
        getFirestore, doc, getDoc, setDoc, onSnapshot, collection, addDoc, serverTimestamp, query, orderBy, arrayUnion
      };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --secondary-color: #03dac6;
            --on-surface-color: #e1e1e1;
            --on-surface-muted: #888;
            --sender-bubble: #373737;
            --receiver-bubble: #004d40;
            --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Roboto', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--bg-color);
            color: var(--on-surface-color);
            padding: 10px;
        }
        .chat-app-container {
            width: 100%;
            max-width: 800px;
            height: 95vh;
            max-height: 850px;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            overflow: hidden;
        }
        /* NEW: Sidebar for contacts */
        .sidebar {
            width: 250px;
            background-color: #181818;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 20px;
        }
        .sidebar h2 {
            text-align: center;
            color: var(--primary-color);
            border-bottom: 1px solid #333;
            padding-bottom: 15px;
        }
        .add-contact-setup {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .add-contact-setup input {
            padding: 8px 12px;
            border: 1px solid #444;
            background: var(--bg-color);
            color: var(--on-surface-color);
            border-radius: 6px;
        }
        .contact-list {
            flex-grow: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .contact-item {
            padding: 12px;
            background-color: var(--surface-color);
            border: 1px solid #444;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
            word-break: break-all;
        }
        .contact-item:hover {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
            color: #000;
        }
        .chat-main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        .header {
            padding: 15px 20px;
            border-bottom: 1px solid #333;
        }
        .user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .user-info p {
            font-size: 0.9rem;
        }
        .user-info code {
            background: #2a2a2a;
            padding: 5px 8px;
            border-radius: 4px;
            color: var(--on-surface-muted);
            word-break: break-all;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background-color: var(--primary-color);
            color: #000;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .btn-copy {
            padding: 5px 10px;
            font-size: 0.8rem;
        }
        #chatWindow {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .message { max-width: 75%; padding: 10px 15px; border-radius: var(--border-radius); line-height: 1.4; }
        .message.sent { background-color: var(--primary-color); color: #000; align-self: flex-end; border-bottom-right-radius: 4px; }
        .message.received { background-color: var(--sender-bubble); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message .timestamp { display: block; font-size: 0.65rem; color: var(--on-surface-muted); text-align: right; margin-top: 5px; opacity: 0.7; }
        .message.sent .timestamp { color: #333; }
        #messageForm { display: flex; padding: 15px; border-top: 1px solid #333; gap: 10px; }
        #messageInput { flex-grow: 1; padding: 12px; border: 1px solid #444; background: var(--bg-color); color: var(--on-surface-color); border-radius: 20px; }
        @media (max-width: 768px) {
            .chat-app-container { flex-direction: column; height: 98vh; }
            .sidebar { width: 100%; height: 250px; border-right: none; border-bottom: 1px solid #333; }
        }
    </style>
</head>
<body>

    <div class="chat-app-container">
        <!-- NEW: Sidebar for Contacts -->
        <aside class="sidebar">
            <h2>Contacts</h2>
            <div class="add-contact-setup">
                <input type="text" id="contactIdInput" placeholder="Paste a User ID to add">
                <button id="addContactBtn" class="btn">Add Contact</button>
            </div>
            <div id="contactList" class="contact-list">
                <p style="color: var(--on-surface-muted); text-align: center;">No contacts yet.</p>
            </div>
        </aside>

        <!-- Main Chat Area -->
        <main class="chat-main">
            <header class="header">
                <div class="user-info">
                    <p>Your User ID:</p>
                    <code id="userIdDisplay">Connecting...</code>
                    <button id="copyIdBtn" class="btn btn-copy">Copy</button>
                </div>
            </header>

            <div id="chatWindow">
                <p style="text-align: center; color: var(--on-surface-muted);">Select a contact to begin chatting.</p>
            </div>

            <form id="messageForm" action="javascript:void(0);">
                <input type="text" id="messageInput" placeholder="Type your message..." autocomplete="off" disabled>
                <button type="submit" id="sendBtn" class="btn" disabled>Send</button>
            </form>
        </main>
    </div>

    <!-- MAIN APPLICATION SCRIPT -->
    <script type="module">
        const __firebase_config = {
            apiKey: "AIzaSyC5djCcWsD1omHW0qLX3lNQvHILZap_Ldc",
            authDomain: "chat-e0dfe.firebaseapp.com",
            projectId: "chat-e0dfe",
            storageBucket: "chat-e0dfe.appspot.com",
            messagingSenderId: "892915152647",
            appId: "1:892915152647:web:dac2846c5f3fb403d7f7a2"
        };
    
        // --- DOM Element References ---
        const userIdDisplay = document.getElementById('userIdDisplay');
        const copyIdBtn = document.getElementById('copyIdBtn');
        const contactIdInput = document.getElementById('contactIdInput');
        const addContactBtn = document.getElementById('addContactBtn');
        const contactList = document.getElementById('contactList');
        const chatWindow = document.getElementById('chatWindow');
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        
        // --- Firebase Globals & App State ---
        let auth, db;
        let currentUserId = null;
        let currentChatRoomId = null;
        let unsubscribeFromMessages = null;

        async function initializeFirebase() {
            try {
                window.firebase.initializeApp(__firebase_config);
                auth = window.firebase.getAuth();
                db = window.firebase.getFirestore();

                window.firebase.onAuthStateChanged(auth, user => {
                    if (user) {
                        currentUserId = user.uid;
                        userIdDisplay.textContent = `${currentUserId.substring(0, 10)}...`;
                        console.log("Authenticated with Secure UID:", currentUserId);
                        loadContacts(); // NEW: Load contacts on login
                    } else {
                        console.log("No user found. Signing in anonymously...");
                        window.firebase.signInAnonymously(auth);
                    }
                });
            } catch (error) {
                console.error("Firebase initialization failed:", error);
            }
        }

        // =========================================================================
        // NEW SECTION: CONTACT MANAGEMENT
        // =========================================================================
        
        async function addContact() {
            const newContactId = contactIdInput.value.trim();
            if (!newContactId || !currentUserId) {
                alert("Please enter a User ID.");
                return;
            }
            if (newContactId === currentUserId) {
                alert("You cannot add yourself as a contact.");
                return;
            }

            // A simple check if the user exists. A more robust app might have better validation.
            const userDocRef = window.firebase.doc(db, "users", newContactId);
            const userDoc = await window.firebase.getDoc(userDocRef);
            
            // We'll assume if a document exists, it's a valid user.
            // In a real app, the user document would contain more profile info.
            
            // Add contact to the current user's document
            const currentUserDocRef = window.firebase.doc(db, "users", currentUserId);
            try {
                // Use arrayUnion to safely add the new contact ID without creating duplicates.
                await window.firebase.setDoc(currentUserDocRef, {
                    contacts: window.firebase.arrayUnion(newContactId)
                }, { merge: true }); // Merge ensures we don't overwrite other data

                console.log("Contact added:", newContactId);
                contactIdInput.value = '';
                loadContacts(); // Refresh the contact list
            } catch (error) {
                console.error("Error adding contact:", error);
                alert("Could not add contact. Please try again.");
            }
        }
        
        async function loadContacts() {
            if (!currentUserId) return;
            const userDocRef = window.firebase.doc(db, "users", currentUserId);
            const userDoc = await window.firebase.getDoc(userDocRef);

            contactList.innerHTML = ''; // Clear the current list

            if (userDoc.exists() && userDoc.data().contacts) {
                const contacts = userDoc.data().contacts;
                if (contacts.length === 0) {
                     contactList.innerHTML = '<p style="color: var(--on-surface-muted); text-align: center;">No contacts yet.</p>';
                } else {
                    contacts.forEach(contactId => {
                        const contactElement = document.createElement('div');
                        contactElement.className = 'contact-item';
                        contactElement.textContent = `${contactId.substring(0, 8)}...`;
                        contactElement.dataset.uid = contactId; // Store the full ID
                        contactElement.addEventListener('click', () => startChat(contactId));
                        contactList.appendChild(contactElement);
                    });
                }
            } else {
                 contactList.innerHTML = '<p style="color: var(--on-surface-muted); text-align: center;">No contacts yet. Add one above!</p>';
            }
        }
        
        // =========================================================================

        function getChatRoomId(uid1, uid2) {
            return uid1 < uid2 ? `${uid1}_${uid2}` : `${uid2}_${uid1}`;
        }
        
        function startChat(recipientId) {
            if (!recipientId || !currentUserId) return;

            if (unsubscribeFromMessages) {
                unsubscribeFromMessages();
            }

            currentChatRoomId = getChatRoomId(currentUserId, recipientId);
            console.log(`Starting chat in room: ${currentChatRoomId}`);
            
            messageInput.disabled = false;
            sendBtn.disabled = false;
            messageInput.placeholder = `Message ${recipientId.substring(0, 8)}...`;
            chatWindow.innerHTML = `<p style="text-align: center; color: var(--on-surface-muted);">Chatting with ${recipientId.substring(0,8)}...</p>`;
            
            listenForMessages();
        }

        function listenForMessages() {
            if (!currentChatRoomId) return;
            const messagesRef = window.firebase.collection(db, "chatRooms", currentChatRoomId, "messages");
            const q = window.firebase.query(messagesRef, window.firebase.orderBy("timestamp"));

            unsubscribeFromMessages = window.firebase.onSnapshot(q, (snapshot) => {
                if(!snapshot.empty) chatWindow.innerHTML = '';
                snapshot.docs.forEach(doc => displayMessage(doc.data()));
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }, (error) => console.error("Error listening to messages:", error));
        }
        
        function displayMessage(messageData) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            const messageType = messageData.senderId === currentUserId ? 'sent' : 'received';
            messageElement.classList.add(messageType);
            messageElement.textContent = messageData.text;
            
            if (messageData.timestamp) {
                const tsEl = document.createElement('span');
                tsEl.className = 'timestamp';
                tsEl.textContent = new Date(messageData.timestamp.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                messageElement.appendChild(tsEl);
            }
            chatWindow.appendChild(messageElement);
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (text && currentChatRoomId && currentUserId) {
                try {
                    await window.firebase.addDoc(window.firebase.collection(db, "chatRooms", currentChatRoomId, "messages"), {
                        text: text,
                        senderId: currentUserId,
                        timestamp: window.firebase.serverTimestamp()
                    });
                    messageInput.value = '';
                    messageInput.focus();
                } catch (error) {
                    console.error("Error sending message:", error);
                }
            }
        }
        
        function copyUserId() {
            navigator.clipboard.writeText(currentUserId).then(() => {
                copyIdBtn.textContent = 'Copied!';
                setTimeout(() => { copyIdBtn.textContent = 'Copy'; }, 2000);
            }, (err) => {
                console.error('Could not copy text: ', err);
            });
        }

        // --- Event Listeners ---
        window.addEventListener('load', initializeFirebase);
        addContactBtn.addEventListener('click', addContact);
        copyIdBtn.addEventListener('click', copyUserId);
        messageForm.addEventListener('submit', sendMessage);

    </script>
</body>
</html>